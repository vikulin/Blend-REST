name: Publish Blend-REST Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0, v1.1, etc.
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create version from tag
        run: |
          TAG_NAME=${{ github.ref_name }}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Create zip distribution
        run: |
          mkdir -p build
          mkdir -p Blend-REST

          # Copy main addon files into the Blend-REST folder
          cp -r actions *.py LICENSE README.md Blend-REST/ || true

          # Create zip with top-level Blend-REST folder
          zip -r "build/Blend-REST-${{ env.TAG_NAME }}.zip" Blend-REST \
            -x "*.git*" ".github/*" "build/*" "examples/*"

          echo "âœ… Created zip: build/Blend-REST-${{ env.TAG_NAME }}.zip"

      - name: Generate changelog
        run: |
          echo "# Blend-REST ${{ env.TAG_NAME }}" > RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "## What's Changed" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          git log -n 10 --pretty=format:"- %s" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "---" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "### ðŸ“¦ Release Contents" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "| File Name | Description |" >> RELEASE_BODY.md
          echo "|-----------|-------------|" >> RELEASE_BODY.md
          echo "| \`Blend-REST-${{ env.TAG_NAME }}.zip\` | Blend-REST Blender Add-on |" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "ðŸ“ **Installation**: Download the zip file and install via Blender's Preferences â†’ Add-ons â†’ Install..." >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "---" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "ðŸ“š **Documentation**: See [README.md](https://github.com/${{ github.repository }}/blob/master/README.md)" >> RELEASE_BODY.md
          echo "" >> RELEASE_BODY.md
          echo "ðŸ› **Report Issues**: [Create an issue](https://github.com/${{ github.repository }}/issues)" >> RELEASE_BODY.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Blend-REST ${{ env.TAG_NAME }}
          tag_name: ${{ env.TAG_NAME }}
          body_path: RELEASE_BODY.md
          files: |
            build/Blend-REST-${{ env.TAG_NAME }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
